# 《迷宫坦克：LLM 大 PK》开发计划（简化版 · 单一场地 · 可无限加坦克）

> 目标：先把**一个固定场地（单一迷宫地图）**做到稳定可玩，再允许**任意数量**（受设备性能约束）的坦克加入。同一页面即可**下载范例 Driver 文件**（JSON / Python），并**导入**任意 Driver 包；导入后自动**识别→校验→就绪**，在列表中以**战队名 + 颜色 + 就绪状态**呈现。点击开始即可在当前场地对战。

---

## 1. 范围与成功标准（MVP）

**范围**

* 单一固定迷宫地图（可复现的 seed；先不做多地图）。
* 多坦克混战（本地单机），坦克数量上不设硬性上限（推荐≤16 以保持 60FPS）。
* 支持上传/导入**Driver 包**（可下载范例 JSON、Python 两种），导入后出现**战队信息**与**准备状态**。
* 基本战斗循环：移动 / 发射 / 捡金币三选一强化 / 击杀 / 到时判分。
* 就绪面板可不断“往 V 迷宫里塞更多坦克”，一键开始对战。

**成功标准**

* 同一 seed + 同一 Driver 组合，结果可复现（事件日志一致）。
* 8 坦克在 50×30 地图上稳定 60FPS（或逻辑 20Hz）。
* 导入 10 份 Driver 包，全部可识别并显示\*\*“{战队名} 的坦克 · 准备就绪”\*\*。
* 可导出回放（便于复盘）。

---

## 2. 技术选型（均为宽松许可）

* **迷宫生成**：`labyrinth/mazejs`（MIT）
* **渲染/场景**：`Phaser 3`（MIT）
* **碰撞/体素**：`Matter.js`（MIT）
* **随机/复现**：`seedrandom`（MIT）
* **Driver 沙箱**：`WebWorker`（必要时用 Comlink 封装；Apache-2.0）

> 说明：保持简单、稳定；后续再考虑 ECS、寻路库等。

---

## 3. 关键功能与模块

### 3.1 场地（迷宫）模块

* 固定 seed 生成一张 50×30 网格迷宫；地图、出生点与金币生成均走同一 RNG。
* 迷宫只读；墙体阻挡，金币刷在可通行格。

### 3.2 坦克与战斗模块

* 坦克属性（可配）：HP=100、Speed=1.0、Atk=10、Def=0%、RoF=1/s。
* 子弹：四向、直线、撞墙/命中即销毁。
* 金币强化：拾取后弹出三选一（速度+10%、攻击+15%、防御+10%，防御封顶 70%）。
* 出生保护：前 2 秒减伤 50%。

### 3.3 Driver（高级运行脚本）模块

* **Driver 包**是一个**可携带、可下载、可导入**的文件（见 §4 文件规范）。
* 导入流程：拖拽/选择文件 → 读取 **manifest** → 校验（字段、版本、签名可选） → 通过后创建一台坦克并标记**准备就绪**。
* 运行：每 200ms 下发一次观测（5Hz），Driver 返回动作（移动/开火/升级）。Driver 在 WebWorker 内运行（隔离、不可联网）。

### 3.4 “参赛队伍”面板（核心 UI）

* 列表项字段：**战队名**（必显，支持重名校验与重命名）、**坦克名**（可同战队多个）、**代表色**（色块）、**状态徽章**（未加载/校验失败/准备就绪）、**删除**。
* 交互：

  * 「**下载范例（JSON）**」「**下载范例（Python）**」
  * 「**导入 Driver**」支持拖拽/点击
  * 导入成功后，显示：**“【XX战队】的坦克 · 准备就绪”**
  * 自动分配颜色（若冲突或缺失）并提示可手动改色
  * 支持一键“全部清空”
* 顶部显示：当前场地名 + 种子；右上角显示**已就绪坦克数量**与**开始战斗**按钮。

### 3.5 裁判与回放模块

* 胜负：剩 1 台或到时（默认 180s）按积分判定；积分 = 击杀×100 + 伤害×1 + 拾金×10 + 存活时长×0.1。
* 事件日志：tick、actorId、eventType（hit/kill/coin/upgrade/death…）、payload。
* 回放：同 seed + 事件流可逐帧重演；导出/导入回放文件。

---

## 4. Driver 包规范（可下载/导入 · 不写代码版）

> **目标**：一份文件既能被我们的 Web 场地识别与运行，也便于“给其他 APP 用”。
> **策略**：统一使用\*\*“便携包（.zip）”\*\*，内含：
>
> * `manifest.json`（核心，供本场地读取与运行）
> * `driver.py`（可选，给其他 Python APP 用；我们不直接执行 Python）
> * `README.md`（可选说明）
> * `icon.png`（可选图标）

**manifest.json 需包含的字段（说明式）**

* `package.name`：包名（字符串）
* `package.version`：版本（语义化）
* `team.name`：战队名（字符串）
* `tank.displayName`：坦克名称（字符串）
* `tank.color`：代表色（HEX；可缺省）
* `engine.apiVersion`：Driver 接口版本（如 `"1.0"`）
* `policy.type`：策略类型（如 `"rule-set" | "fsm" | "llm-hint"`）
* `policy.payload`：策略数据（与 `type` 对应；可为规则表、状态机定义、或用于提示的特征权重）
* `constraints`：可选限制（如最大决策时间 50ms）
* `signature`：可选签名（用于第三方验真）

> **我们的运行核心只依赖 `manifest.json`**。如果上传的是**单文件 JSON**，也视为等价的 `manifest.json`。上传 `.py` 或其他文件，则提示“未识别为便携包”，引导用户改用便携包或仅读取其中的元数据（仅用于显示，不参与运行）。

**校验规则（通过即“准备就绪”）**

* JSON 结构与字段完整（必填字段均存在）。
* 版本兼容（`engine.apiVersion` 匹配当前引擎）。
* 策略合法（`policy.type` 可识别；`payload` 非空且大小不超限）。
* 颜色冲突解决：如缺失或重复，自动分配新色并提示“已自动改色”。

---

## 5. 交互流程（关键用户旅程）

**A. 下载范例 → 导入 → 就绪**

1. 用户点击「下载范例（JSON/Python）」得到 `driver-example.zip`（含 manifest.json 与 driver.py）。
2. 回到“参赛队伍”面板，拖拽 zip 进入导入框。
3. 系统解析 manifest → 校验通过 → 分配出生点/代表色 → 列表新增：

   * **战队名（色块）｜坦克名｜状态：准备就绪**
4. 用户可重复导入多份包（同队或不同队），数量不限（性能提示）。

**B. 清单管理**

* 列表项可“改色 / 重命名 / 删除”；冲突有红色提示。
* 顶部计数实时变化：“已就绪 X 台”。

**C. 开始对战**

* 点击「开始战斗」，对当前“准备就绪”的所有坦克开局；UI 收起导入区，展示 HUD（计时/比分）。
* 结束后显示结果面板，可导出回放。

---

## 6. 数据与状态（不涉代码，仅结构说明）

**坦克注册表（内存模型）**

* `tanks[]`：{ `id`, `teamName`, `displayName`, `color`, `status`, `driverRef`, `spawnPos` }

  * `status ∈ { 未加载, 校验失败, 准备就绪 }`

**Driver 运行时接口（概念）**

* **Observation（输入）**：tick、自身状态、周围实体列表（敌人/子弹/金币）、迷宫摘要、最近事件。
* **Action（输出）**：`move ∈ {UP,DOWN,LEFT,RIGHT,STOP}`；`fire ∈ {UP,DOWN,LEFT,RIGHT,NONE}`；`upgrade ∈ {SPEED,ATK,DEF,NONE}`。
* **节流**：5Hz 下发观测；50ms 未返回则沿用上一动作。

---

## 7. 质量与性能基线

* 60FPS 渲染、20Hz 逻辑；8 坦克稳定；≥16 坦克允许降到 45–60FPS。
* 回放与原局事件序列一致（哈希一致）。
* 单场 180s 日志 ≤ 2MB（事件压缩）。
* 恶意/异常 Driver 不崩全局：Worker 超时/异常时该帧置 `STOP` 并计入“超时率”。

---

## 8. 项目里程碑与任务拆解（两周内完成）

### 周期 1（第 1–4 天）：场地 + 核心循环

* ✅ 迷宫生成与固定 seed（labyrinth + seedrandom）
* ✅ Phaser 场景/摄像机、网格→像素映射
* ✅ 坦克/墙体碰撞（Matter.js），金币拾取 & 三选一强化
* ✅ 计时器、到时结束、基础积分

**验收**：单一假人坦克可移动/捡币/对战；同 seed 复现稳定。

### 周期 2（第 5–7 天）：Driver 包与就绪面板

* ✅ 便携包（zip+manifest）解析与校验
* ✅ “参赛队伍”面板：下载范例、导入、冲突处理、颜色分配、状态徽章
* ✅ 多坦克开局、出生保护、HUD（K/Dmg/Coins/HP）

**验收**：导入 10 包均显示“准备就绪”，可一键开始对战。

### 周期 3（第 8–10 天）：沙箱与稳定性

* ✅ WebWorker 驱动：5Hz 决策、50ms 超时回退、统计超时率
* ✅ 非法行为防护：禁网、禁动态 import；异常隔离
* ✅ 回放记录/导出与逐帧播放

**验收**：两次回放与原局完全一致；恶意包不影响对局。

### 周期 4（第 11–14 天）：打磨与交付

* ✅ 性能优化（批渲染、对象池）、内存回收
* ✅ 文档：参赛指南（如何打包 manifest/driver、字段表、限制）、FAQ
* ✅ 发布构建 & 许可证随包（MIT）

**验收**：8 坦克 180s 无掉帧；新手 30 分钟内完成导入就绪并开打一局。

---

## 9. 测试清单（要点）

* **导入**：非法 JSON、缺字段、过大 payload、重复颜色/名称、版本不兼容。
* **状态**：导入→校验失败（红标）、修正后再次导入→准备就绪（绿标）。
* **并发**：连续导入 20 次无内存暴涨；删除/清空后可再次导入。
* **复现**：同组合三次对局事件哈希一致。
* **稳定**：Driver 故障（超时、抛错）不影响主线程渲染。

---

## 10. 交付物

* **Web 可执行包**（单一场地版本）
* **范例 Driver 包**：`driver-example.zip`

  * `manifest.json`（完整字段与示例值）
  * `driver.py`（仅示范算法思路与元数据；供他处参考）
* **参赛指南**（Markdown）
* **回放样例**（方便演示）

---

### 结尾备注

我们先把\*\*“一个场地 + 无限加坦克 + Driver 包导入/就绪”\*\*这一条链路打通，稳定跑起来；后续若要扩展（多地图、在线赛、排行榜），基于当前包/面板即可无缝延伸。
